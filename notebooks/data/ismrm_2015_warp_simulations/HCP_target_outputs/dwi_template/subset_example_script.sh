#!/usr/bin/bash

set -eou pipefail

while IFS="" read -r subj || [ -n "$subj" ]; do printf '===================================================%s\n' "$subj" ; subs_d="${subj}/03_fiberfox_prep/dwi_subsets"; mkdir -p "$subs_d"; dwi_pref="hcp-${subj}_target_space_dwi"; mrconvert -force "${subj}/03_fiberfox_prep/hcp-${subj}_target_space_dwi.nii.gz" -fslgrad "${subj}/03_fiberfox_prep/hcp-${subj}_target_space_dwi.bvecs" "${subj}/03_fiberfox_prep/hcp-${subj}_target_space_dwi.bvals" -coord 3 0 "${subs_d}/b0_singleton.mif" || break; dwiextract -force "${subj}/03_fiberfox_prep/${dwi_pref}.nii.gz" -fslgrad "${subj}/03_fiberfox_prep/${dwi_pref}.bvecs" "${subj}/03_fiberfox_prep/${dwi_pref}.bvals" -shells 1000,3000 "${subs_d}/all_shells.mif"; mrconvert "${subs_d}/all_shells.mif" -coord 3 0:44 - | mrcat "${subs_d}/b0_singleton.mif" - - | mrconvert -force -bvalue_scaling false - "${subs_d}/01_${dwi_pref}.nii.gz" -export_grad_fsl "${subs_d}/01_${dwi_pref}.bvecs" "${subs_d}/01_${dwi_pref}.bvals"; mrconvert "${subs_d}/all_shells.mif" -coord 3 45:89 - | mrcat "${subs_d}/b0_singleton.mif" - - | mrconvert -force -bvalue_scaling false - "${subs_d}/02_${dwi_pref}.nii.gz" -export_grad_fsl "${subs_d}/02_${dwi_pref}.bvecs" "${subs_d}/02_${dwi_pref}.bvals"; mrconvert "${subs_d}/all_shells.mif" -coord 3 90:134 - | mrcat "${subs_d}/b0_singleton.mif" - - | mrconvert -force -bvalue_scaling false - "${subs_d}/03_${dwi_pref}.nii.gz" -export_grad_fsl "${subs_d}/03_${dwi_pref}.bvecs" "${subs_d}/03_${dwi_pref}.bvals"; mrconvert "${subs_d}/all_shells.mif" -coord 3 135:179 - | mrcat "${subs_d}/b0_singleton.mif" - - | mrconvert -force -bvalue_scaling false - "${subs_d}/04_${dwi_pref}.nii.gz" -export_grad_fsl "${subs_d}/04_${dwi_pref}.bvecs" "${subs_d}/04_${dwi_pref}.bvals"; rm -fv "${subs_d}"/*.mif; done < HCP_sub_ids.txt
